<?xml version="1.0"?>
<TeamMentor_Article Metadata_Hash="0" Content_Hash="0">
  <Metadata>
    <Id>00000000-0000-0000-0000-000000851c28</Id>
    <Library_Id>f798e6e6-1732-4172-9c47-9621d914efcd</Library_Id>
    <Title>Include Unique Tokens in HTTP Requests</Title>
    <Category>Session Management</Category>
    <Phase>Implementation</Phase>
    <Technology>PHP</Technology>
    <Type>Guideline</Type>
    <DirectLink>Include Unique Tokens in HTTP Requests</DirectLink>
    <Author />
    <Priority />
    <Status />
  </Metadata>
  <Content Sanitized="false" DataType="html">
    <Data><![CDATA[<h1>What to Do</h1>
  <p>Include unique tokens in HTTP requests when performing sensitive operations to prevent Cross-Site Request Forgery (CSRF).</p>
  <h1>Why</h1>
  <p>CSRF may be possible when an attacker can form a URL, which performs an action on the behalf of an authenticated user. Forming such URLs becomes much more difficult, if unique tokens are included in HTTP requests. Including difficult to predict token in HTTP requests is an effective defense against CSRF attacks.</p>
  <h1>How</h1>
  <p>To include unique tokens in HTTP requests:</p>
  <ol>
    <li>
      <p>
        <strong>Identify sensitive operations.</strong> Review application design and code to identify all operations that require authorization.</p>
    </li>
    <li>
      <p>
        <strong>Identify code that performs sensitive operations. </strong>Identify all pages that are involved in performing sensitive operations - this includes both the pages that link to sensitive operations and the code that actually carries out the sensitive operations.</p>
    </li>
    <li>
      <p />
      <strong>Choose a method for generating unique tokens.</strong> There are different ways to generate unique tokens. One approach is to use the uniqid function combined with a hash based on current time. For example: <pre>uniqid(md5(microtime()), true);</pre></li>
    <li>
      <p />
      <strong>Add the unique token to the session.</strong> Add code that adds the generates unique tokens and stores them in session variables to the pages that link to sensitive operations. For example: <pre>session_start();<br />$_SESSION['CSRFToken'] = uniqid(md5(microtime()), true);</pre></li>
    <li>
      <p />
      <strong>Add unique tokens to HTTP requests.</strong> Add code that sends the generated unique tokens in HTTP requests to the pages that link to sensitive operations. One of the simplest ways to do this is to include the tokens in hidden fields in forms. For example:<pre>&lt;input type="hidden" name="CSRFToken" value="&lt;?php echo $_SESSION['CSRFToken'] ?&gt;" /&gt;</pre></li>
    <li>
      <p />
      <strong>Add token validation code.</strong> Add code to the pages that carry out sensitive operations that compares the tokens sent in HTTP requests to the tokens stored in session variables. Comparing the tokens in HTTP requests to tokens in session variables makes sure that the tokens are generated by the server as a part of normal application workflow and therefore the requested action is being performed by a legitimate user. The validation code should look something like the following:<pre>session_start();<p /><p>if ($_POST['CSRFToken'] !== $_SESSION['CSRFToken']) {<br />&amp;nbsp; // The tokens don't match - possible CSRF detected<br />&amp;nbsp; die('Possible CSRF');<br />}<br />// Validation passed, so tokens match - perform the sensitive operation</p></pre></li>
  </ol>
  <h1>Additional Resources</h1>
  <ul>
    <li>For information about the OWASP CSRFGuard project, please see <a href="https://www.owasp.org/index.php/Category:OWASP_CSRFGuard_Project">https://www.owasp.org/index.php/Category:OWASP_CSRFGuard_Project</a></li>
  </ul>
  <ul>
  </ul>]]></Data>
  </Content>
</TeamMentor_Article>